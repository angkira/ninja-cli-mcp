name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.1)'
        required: true
      skip_tests:
        description: 'Skip tests before release'
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Run tests before release (can be skipped for hotfixes)
  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run linter
        run: uv run ruff check src/

      - name: Run tests
        run: uv run pytest tests/ -v --tb=short

  build-python:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build package
        run: uv build

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-packages
          path: dist/*

  build-debian:
    name: Build Debian Package
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gzip

      - name: Build Debian package
        run: |
          chmod +x scripts/packaging/build-deb.sh
          ./scripts/packaging/build-deb.sh

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: packaging/debian/*.deb

  build-homebrew:
    name: Build Homebrew Formula
    runs-on: ubuntu-latest
    needs: build-python

    steps:
      - uses: actions/checkout@v4

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-packages
          path: dist/

      - name: Build Homebrew formula
        run: |
          chmod +x scripts/packaging/build-homebrew.sh
          ./scripts/packaging/build-homebrew.sh

      - name: Upload Homebrew formula
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula
          path: packaging/homebrew/*.rb

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-python, build-debian, build-homebrew]
    permissions:
      contents: write

    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD --no-merges | head -20)
          else
            COMMITS=$(git log --pretty=format:"- %s" -20 --no-merges)
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Ninja MCP v${{ steps.get_version.outputs.version }}
          body: |
            ## ðŸ¥· Ninja MCP v${{ steps.get_version.outputs.version }}

            ### What's Changed
            ${{ steps.changelog.outputs.commits }}

            ### Installation

            **Quick Install (Recommended):**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/angkira/ninja-cli-mcp/main/install.sh | bash
            ```

            **PyPI:**
            ```bash
            uv tool install ninja-mcp[all]
            # or
            pip install ninja-mcp[all]
            ```

            **Homebrew (macOS):**
            ```bash
            brew install angkira/ninja-mcp/ninja-mcp
            ```

            **Debian/Ubuntu:**
            ```bash
            wget https://github.com/angkira/ninja-cli-mcp/releases/download/v${{ steps.get_version.outputs.version }}/ninja-mcp_${{ steps.get_version.outputs.version }}_all.deb
            sudo dpkg -i ninja-mcp_${{ steps.get_version.outputs.version }}_all.deb
            ```

            ### Setup

            After installation, configure for Claude Code:
            ```bash
            ninja-config doctor --fix  # Diagnose and fix issues
            ```

            ### Assets
            - `ninja_mcp-*.whl` - Python wheel (pip/uv install)
            - `ninja_mcp-*.tar.gz` - Source distribution
            - `ninja-mcp_*_all.deb` - Debian/Ubuntu package
            - `ninja-mcp.rb` - Homebrew formula

            ### Documentation
            - [Installation Guide](https://github.com/angkira/ninja-cli-mcp/blob/main/INSTALL_GUIDE.md)
            - [Claude Code Integration](https://github.com/angkira/ninja-cli-mcp/blob/main/docs/CLAUDE_CODE_2026_INTEGRATION.md)
          files: |
            python-packages/*
            debian-packages/*.deb
            homebrew-formula/*.rb
          draft: false
          prerelease: false

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/project/ninja-mcp/
    permissions:
      id-token: write

    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-packages
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true

  notify-success:
    name: Release Complete
    runs-on: ubuntu-latest
    needs: [create-release, publish-pypi]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release v${{ needs.create-release.outputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release: âœ…" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.publish-pypi.result }}" == "success" ]]; then
            echo "- PyPI Publish: âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "- PyPI Publish: â­ï¸ (skipped or failed)" >> $GITHUB_STEP_SUMMARY
          fi
